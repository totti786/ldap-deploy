[global]
    workgroup = {{ samba_workgroup }}
    realm = {{ samba_realm | upper }}
    netbios name = {{ ansible_hostname | upper }}
    
    security = user
    passdb backend = ldapsam:{{ samba_ldap_url | default('ldap://ldap.example.com') }}
    
    ldap admin dn = {{ samba_ldap_admin_dn | default('cn=admin,dc=example,dc=com') }}
    ldap suffix = {{ ldap_base_dn }}
    ldap user suffix = ou=People
    ldap group suffix = ou=Groups
    ldap machine suffix = ou=Computers
    ldap idmap suffix = ou=Idmap
    
    ldap ssl = start tls
    ldap delete dn = yes
    
    log level = 2
    log file = /var/log/samba/log.%m
    max log size = 5000
    
    domain master = yes
    domain logons = yes
    preferred master = yes
    
    smb ports = 445
    client min protocol = SMB2
    server min protocol = SMB2

[homes]
    comment = Home Directories
    browseable = no
    writable = yes
    create mask = 0700
    directory mask = 0700

[netlogon]
    comment = Network Logon Service
    path = /var/lib/samba/netlogon
    guest ok = yes
    writable = no

[profiles]
    comment = User Profiles
    path = /var/lib/samba/profiles
    browseable = no
    writable = yes
    create mask = 0600
    directory mask = 0700

{% for share in samba_shares | default([]) %}
[{{ share.name }}]
    comment = {{ share.comment }}
    path = {{ share.path }}
    browseable = {{ share.browseable | default('yes') }}
    writable = {{ share.writable | default('yes') }}
    {% if share.valid_users is defined %}
    valid users = {{ share.valid_users }}
    {% endif %}
{% endfor %}
